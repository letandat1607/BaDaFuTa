name: CI - Test all services

on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test_backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Run Backend Tests
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.test.yml up \
            --build \
            postgres \
            rabbitMQ \
            user_service \
            merchant_service \
            order_service \
            payment_service \
            drone_delivery_service \
            gateway
            
          docker compose -f docker-compose.yml -f docker-compose.override.test.yml up --abort-on-container-exit

      - name: Wait for all tests to complete
        run: |
          services="user_service merchant_service order_service payment_service drone_delivery_service gateway"
          
          for service in $services; do
            echo "Waiting for $service to finish..."
            
            # Đợi container exit (timeout 30 minutes)
            timeout 1800 bash -c "until [ \$(docker compose ps -q $service | xargs docker inspect -f '{{.State.Running}}') == 'false' ]; do sleep 5; done" || echo "$service might still be running"
          done
          
          echo "All services completed"

      - name: Check test results
        run: |
          echo "=== Test Results ==="
          
          services="user_service merchant_service order_service payment_service drone_delivery_service gateway"
          all_passed=true
          
          for service in $services; do
            exit_code=$(docker compose ps -a $service --format json | jq -r '.ExitCode')
            
            if [ "$exit_code" = "0" ]; then
              echo "$service: PASSED"
            else
              echo "$service: FAILED (exit code: $exit_code)"
              all_passed=false
            fi
          done
          
          if [ "$all_passed" = "false" ]; then
            echo ""
            echo "Some tests failed. Check logs above."
            exit 1
          fi

      - name: Extract backend coverage
        if: always()
        run: |
          mkdir -p coverage-output/backend
          
          for service in user_service merchant_service order_service payment_service drone_delivery_service gateway; do
            echo "Extracting coverage from $service..."
            docker compose cp $service:/app/coverage coverage-output/backend/$service 2>/dev/null || echo "⚠️  No coverage for $service"
          done

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose logs --tail=200

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-${{ github.run_number }}
          path: coverage-output/backend/
          retention-days: 14
      
      - name: Cleanup Docker & .env
        if: always()
        run: |
          echo "=== Cleaning up containers, volumes, networks ==="
          docker compose -f docker-compose.yml -f docker-compose.override.yml down -v --remove-orphans || true
          
          echo "=== Prune dangling images & build cache ==="
          docker system prune -f || true
          
          echo "=== Remove temporary .env file ==="
          rm -f .env || true
          
          echo "=== Cleanup completed ==="

  test_frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-frontend-${{ hashFiles('frontend/Dockerfile.dev') }}
          restore-keys: |
            ${{ runner.os }}-docker-frontend-

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Test frontend
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.test.yml --profile frontend up \
            --build \
            --abort-on-container-exit \
            --exit-code-from frontend \
            frontend

      - name: Check frontend exit code
        if: always()
        run: |
          echo "=== Frontend Container Status ==="
          docker compose ps -a frontend

      - name: Extract frontend coverage
        if: always()
        run: |
          mkdir -p coverage-output/frontend
          
          echo "Extracting coverage from frontend..."
          docker compose cp frontend:/app/coverage coverage-output/frontend 2>/dev/null || echo "No coverage for frontend"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Frontend Logs ==="
          docker compose logs frontend --tail=200

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_number }}
          path: coverage-output/frontend/
          retention-days: 14

      - name: Cleanup frontend
        if: always()
        run: |
          docker compose --profile frontend-test down -v --remove-orphans
          rm -f .env

  test-summary:
    name: Generate Test Summary
    needs: [test_backend, test_frontend]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download backend coverage
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-${{ github.run_number }}
          path: coverage-backend/
        continue-on-error: true

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_number }}
          path: coverage-frontend/
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Backend Services" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-backend.result }}" == "success" ]; then
            echo "Backend tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Backend tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Frontend" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test-frontend.result }}" == "success" ]; then
            echo "Frontend tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Frontend tests failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage Reports" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "coverage-backend" ]; then
            for service in user_service merchant_service order_service payment_service drone_delivery_service gateway; do
              if [ -d "coverage-backend/$service" ]; then
                echo "**$service** - Coverage generated" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          if [ -d "coverage-frontend" ]; then
            echo "**frontend** - Coverage generated" >> $GITHUB_STEP_SUMMARY
          fi