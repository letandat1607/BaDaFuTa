name: CI - Test all services

on: 
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test_backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Run Backend Tests
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.test.yml up \
            --build \
            user_service \
            merchant_service \
            order_service \
            payment_service \
            drone_delivery_service \
            gateway
          
          echo "All services completed"

      - name: Check test results
        run: |
          echo "=== Test Results ==="
          
          services="user_service merchant_service order_service payment_service drone_delivery_service gateway"
          all_passed=true
          
          for service in $services; do
            exit_code=$(docker compose ps -a $service --format json | jq -r '.ExitCode')
            
            if [ "$exit_code" = "0" ]; then
              echo "$service: PASSED"
            else
              echo "$service: FAILED (exit code: $exit_code)"
              all_passed=false
            fi
          done
          
          if [ "$all_passed" = "false" ]; then
            echo ""
            echo "Some tests failed. Check logs above."
            exit 1
          fi

      - name: Show logs of all services
        run: |
          echo "=== User Service Logs ==="
          docker compose logs user_service --tail=200
          echo ""
          echo "=== Merchant Service Logs ==="
          docker compose logs merchant_service --tail=200
          echo ""
          echo "=== Order Service Logs ==="
          docker compose logs order_service --tail=200
          echo ""
          
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker compose logs --tail=200
      
      - name: Cleanup Docker & .env
        if: always()
        run: |
          echo "=== Cleaning up containers, volumes, networks ==="
          docker compose -f docker-compose.yml -f docker-compose.override.yml down -v --remove-orphans || true
          
          echo "=== Prune dangling images & build cache ==="
          docker system prune -f || true
          
          echo "=== Remove temporary .env file ==="
          rm -f .env || true
          
          echo "=== Cleanup completed ==="

  test_frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-docker-frontend-${{ hashFiles('frontend/Dockerfile.dev') }}
          restore-keys: |
            ${{ runner.os }}-docker-frontend-

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Test frontend
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.test.yml --profile frontend up \
            --build \
            --abort-on-container-exit \
            --exit-code-from frontend \
            frontend

      - name: Check frontend exit code
        if: always()
        run: |
          echo "=== Frontend Container Status ==="
          docker compose ps -a frontend

      - name: Extract frontend coverage
        if: always()
        run: |
          mkdir -p coverage-output/frontend
          
          echo "Extracting coverage from frontend..."
          docker compose cp frontend:/app/coverage coverage-output/frontend 2>/dev/null || echo "No coverage for frontend"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Frontend Logs ==="
          docker compose logs frontend --tail=200

      - name: Upload frontend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-${{ github.run_number }}
          path: coverage-output/frontend/
          retention-days: 14

      - name: Cleanup frontend
        if: always()
        run: |
          docker compose --profile frontend-test down -v --remove-orphans
          rm -f .env

  test_e2e:
    name: E2E Tests with Cypress
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test_backend, test_frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Make seed script executable
        run: |
          chmod +x test/seed-database.sh

      - name: Start E2E environment
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml up -d --build
          
          echo "Waiting for services to start..."
          sleep 30

      - name: Show service status
        run: |
          echo "=== Service Status ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml ps
          echo ""
          echo "=== Checking frontend health file ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml exec frontend ls -la /tmp/ || true

      - name: Show service logs
        run: |
          echo "=== Docker Compose Logs (last 200 lines) ==="
          docker compose \
            -f docker-compose.yml \
            -f docker-compose.override.e2e.yml \
            logs

      - name: Run Cypress E2E tests
        run: |
          echo "Running Cypress tests..."
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml run --rm cypress

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Gateway Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs gateway --tail=100
          echo ""
          echo "=== Frontend Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs frontend --tail=100
          echo ""
          echo "=== User Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs user_service --tail=100
          echo ""
          echo "=== Merchant Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs merchant_service --tail=100
          echo ""
          echo "=== Order Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs order_service --tail=100
          echo ""
          echo "=== Payment Logs ==="
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml logs payment_service --tail=100
          echo ""

      - name: Upload Cypress screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots-${{ github.run_number }}
          path: test/cypress/screenshots/
          retention-days: 7

      - name: Upload Cypress videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos-${{ github.run_number }}
          path: test/cypress/videos/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f docker-compose.yml -f docker-compose.override.e2e.yml down -v --remove-orphans
          rm -f .env
